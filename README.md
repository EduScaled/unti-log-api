# Описание

Микросервис по хранению и выдачи логов по определенному набору параметров.
Используемый стек: ```python3.7```, ```aiohttp3.4```, ```mysql5.7```

# Установка

1. Создать и активировать виртуальную среду

    ```$ virtualenv -p python3.7 venv```
    ```$ source venv/bin/activate```

2. Установить зависимости
    ```$ pip install -r requirements.txt```

3. Задать настройки приложения

    В папке ```config``` находятся заготовки для разных режимов запуска. Для локального запуска необходимо создать файл dev.yaml и задать требуемые параметры (в качестве примера можно использовать ```dev.yaml.example```). БД конфигурируется в разделе mysql (опускаю описание очевидных параметров),  ```minsize``` и ```maxsize``` задают минимальное и максимальное количество соединений в пулле.

4. Подготовка БД 

    Необходимо создать таблицу в БД.
Либо вручную, используя sql-скрипт ```init_db.sql```, либо запустив вспомогательный скрипт ```init_db.py```.
Скрипт может принимать в параметрах наименование конфигурационного файла  - ```init_db.py --config=test```. По-умолчанию используется файл настроек ```dev.yaml```
В случае, когда необходимо заполнить БД тестовыми значениями, можно воспользоваться скриптом  ```populate_db.py```, который также может принимать параметр с наименованием конфигурационного файла.

# Запуск приложения
Приложение можно запускать в трех различных вариантов, а именно:

- С помощью встроенного сервера

    ```$ python run.py --config=<config_name> ```
    Параметр ```--config``` можно пропустить, в таком случае по-умолчанию будет использован файл ```config/dev.yaml```

- С помощью Gunicorn

    ```$ gunicorn 'app.main:wsgi("<config_name>")' -b 0.0.0.0:<port> -k aiohttp.GunicornWebWorker -w <workers>```,  где ```<config_name>``` - имя конфигурационного файла (**внимание**, в данном способе запуска указывать кофнигурационный файл обязательно, по-умолчанию значение не подставляется), ```<port>``` - TCP-порт, по которому будет доступно приложение, ```<workers>``` - количество "воркеров".

- C помощью Docker

    Необходимо собрать docker-образ
    ```docker build . -t <image_name>```, где ```<image_name>``` - желаемое имя docker-образа
    После чего запустить контейтнер
    ```docker run -d -p <port>:8080 -e CONFIG=<config_name> --name <container_name> <image_name>```, где ```<port>``` - желаемый TCP-порт, ```<config_name>``` - имя конфигурационного файла, обязательное значение , ```<container_name>``` - желаемое имя контейера, ```<image_name>``` - docker-образ, из которого будет запущен контейнер.
    Если БД также запущена в контенера, необходимо добавить к комманде к запуску "линковку" данного контейнера с контейнером БД - ```--link <db_container_name>:mysql5.7```,  где ```<db_container_name>``` - наименование существующего docker-контейнера с БД.
    В случае развертывания БД иным способом настройка связки "контенер-БД" ложится полностью на плечи читающего данный файл.


# Использование

##### Получение логов

Метод: ```POST```
URL:  ```/logs/list/```
HTTP-загловок: ```Context-type: application/json```
 
В теле запроса нужно передать либо пустой ```json``` (```{}```), либо ```json``` с параметрами (в различной вариации)
```
{
	"type": "info",
	"email": "john@doe.com",
	"action": "action",
	"user_id": 1,
	"date_gt": "2000-01-01 00:00",
	"date_lt": "2000-01-01 23:59"
}
````

Ответ:

```
{
    "logs": [
        {
            "id": 1,
            "user_id": 6679,
            "email": "EH97O9ITFFUFW1W5KAMC",
            "type": "error",
            "action": "XO8TR7RMXHMHBPE7SIE2N6Q99WW5Y482NJKOAWVBRQIYXT9F5S",
            "url": "Y836V42ZV72NTSWFA84Z679SUNHS45QI4Q67DP306O7QWVJER1",
            "created_at": "2018-09-10 10:20:51"
        },
        {
            "id": 2,
            "user_id": 4895,
            "email": "LZ1TS3LWXSFY648IL97U",
            "type": "info",
            "action": "7F7N8PBFGSV130F6JJR4D6STD2WDWW2W0HLFO25YSTZBJF91ZG",
            "url": "8L96BHBFAJ2IR9F309XV0LOVHM7R3CW42KGKYP3A3LS7NFPRW8",
            "created_at": "2018-09-10 10:20:51"
        }
    ]
}
```

##### Запись лога

Метод: ```POST```
URL:  ```/logs/add/```
HTTP-загловок: ```Context-type: application/json```

В теле запроса передать json вида 
```
{
	"user_id": 1,
	"email": "jane@doe.com",
	"type": "debug",
	"action": "action",
	"url": "/qwerty/12345/"
}
```
Обязательными параметрами являются ```user_id```, ```type```, ```action```

Ответ:

```
{
    "log": {
        "user_id": 3,
        "email": "jane@doe.com",
        "type": "debug",
        "action": "action",
        "url": "/qwerty/12345/"
    }
}
```

To be continued...